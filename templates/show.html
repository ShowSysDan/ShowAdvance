{% extends "base.html" %}
{% block title %}{{ show.name }} — ShowAdvance{% endblock %}

{% block content %}

{# ─── Macros ─────────────────────────────────────────────────────────────── #}
{% macro adv(key, default='') %}{{ advance_data.get(key, default) }}{% endmacro %}
{% macro meta(key, default='') %}{{ schedule_meta.get(key, default) }}{% endmacro %}
{% macro note(key, default='') %}{{ notes_data.get(key, default) }}{% endmacro %}

{% macro contact_select(key, label, dept) %}
<div class="field-group">
  <label class="field-label">{{ label }}</label>
  <select name="{{ key }}" class="field-input adv-field" data-key="{{ key }}" {% if restricted %}disabled{% endif %}>
    <option value="">— Select —</option>
    <option value="-" {% if adv(key) == '-' %}selected{% endif %}>N/A</option>
    {% for c in contacts_by_dept.get(dept, []) %}
    <option value="{{ c.name }}" {% if adv(key) == c.name %}selected{% endif %}>{{ c.name }}{% if c.title %} · {{ c.title }}{% endif %}</option>
    {% endfor %}
  </select>
</div>
{% endmacro %}

{# ─── Dynamic field renderer ─────────────────────────────────────────────── #}
{% macro render_adv_field(field) %}
{% set span = 'span 6' if field.width_hint == 'full' else ('span 2' if field.width_hint == 'third' else 'span 3') %}
{% set cur = adv(field.field_key) %}

{% if field.field_type == 'checkbox' %}
  <label class="checkbox-label adv-field-wrapper" style="grid-column:{{ span }}" {% if field.conditional_show_when %}data-show-when="{{ field.conditional_show_when }}"{% endif %}>
    <input type="checkbox" class="adv-checkbox adv-field" data-key="{{ field.field_key }}"
           {% if cur == 'true' %}checked{% endif %} {% if restricted %}disabled{% endif %}>
    {{ field.label }}
  </label>

{% elif field.is_notes_field %}
  <div class="notes-section" style="grid-column:span 6">
    <button type="button" class="notes-toggle" onclick="toggleNotes(this)">▸ {{ field.label }}</button>
    <div class="notes-body hidden">
      <textarea class="field-input field-textarea adv-field" data-key="{{ field.field_key }}"
                rows="3" placeholder="{{ field.placeholder }}" {% if restricted %}disabled{% endif %}>{{ cur }}</textarea>
    </div>
  </div>

{% else %}
  {# Wrap in conditional div if needed #}
  {% if field.conditional_show_when %}
  <div class="conditional-block adv-field-wrapper" style="grid-column:{{ span }}" data-show-when="{{ field.conditional_show_when }}">
  {% endif %}

  <div class="field-group{% if not field.conditional_show_when %} adv-field-wrapper{% endif %}"
       {% if not field.conditional_show_when %}style="grid-column:{{ span }}"{% endif %}>
    <label class="field-label">{{ field.label }}</label>

    {% if field.field_type == 'yes_no' %}
      <select class="field-input adv-field" data-key="{{ field.field_key }}" {% if restricted %}disabled{% endif %}>
        <option value="-" {% if cur in ['-',''] %}selected{% endif %}>—</option>
        <option value="Yes" {% if cur == 'Yes' %}selected{% endif %}>Yes</option>
        <option value="No" {% if cur == 'No' %}selected{% endif %}>No</option>
      </select>

    {% elif field.field_type == 'select' %}
      <select class="field-input adv-field" data-key="{{ field.field_key }}" {% if restricted %}disabled{% endif %}>
        {% if field.field_key == 'venue' and venue_list %}
          {% for opt in venue_list %}
          <option value="{{ opt }}" {% if cur == opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        {% elif field.field_key == 'radio_channel' and radio_channel_list %}
          <option value="">— Select —</option>
          {% for opt in radio_channel_list %}
          <option value="{{ opt }}" {% if cur == opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        {% else %}
          {% for opt in field.options %}
          <option value="{{ opt }}" {% if cur == opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        {% endif %}
      </select>

    {% elif field.field_type == 'contact_dropdown' %}
      <select class="field-input adv-field" data-key="{{ field.field_key }}" {% if restricted %}disabled{% endif %}>
        <option value="">— Select —</option>
        <option value="-" {% if cur == '-' %}selected{% endif %}>N/A</option>
        {% for c in contacts_by_dept.get(field.contact_dept, []) %}
        <option value="{{ c.name }}" {% if cur == c.name %}selected{% endif %}>{{ c.name }}{% if c.title %} · {{ c.title }}{% endif %}</option>
        {% endfor %}
      </select>

    {% elif field.field_type == 'textarea' %}
      <textarea class="field-input field-textarea adv-field" data-key="{{ field.field_key }}"
                rows="3" placeholder="{{ field.placeholder }}" {% if restricted %}disabled{% endif %}>{{ cur }}</textarea>

    {% else %}
      {# text / date / time / number #}
      <input type="{{ field.field_type }}" class="field-input adv-field"
             data-key="{{ field.field_key }}"
             value="{{ cur }}"
             placeholder="{{ field.placeholder }}"
             {% if restricted %}disabled{% endif %}>
    {% endif %}
  </div>

  {% if field.conditional_show_when %}
  </div>
  {% endif %}
{% endif %}
{% endmacro %}

{# ─── Page Header ─────────────────────────────────────────────────────────── #}
<div class="page-header show-header">
  <div>
    <a href="{{ url_for('dashboard') }}" class="back-link">← All Shows</a>
    <h1 class="page-title">{{ show.name }}</h1>
    <p class="page-sub">
      {% if show.show_date %}{{ show.show_date }}{% endif %}
      {% if show.show_time %} · {{ show.show_time }}{% endif %}
      {% if show.venue %} · {{ show.venue }}{% endif %}
      {% if show.status == 'archived' %}<span class="badge-archived">ARCHIVED</span>{% endif %}
      {% if restricted %}<span class="badge-archived" style="background:#4A5568">VIEW ONLY</span>{% endif %}
    </p>
    {% if last_saved_display_name %}
    <p class="last-saved-hint">Last saved by <strong>{{ last_saved_display_name }}</strong>
      {% if last_saved_at %} · {{ last_saved_at[:16].replace('T',' ') }}{% endif %}
    </p>
    {% endif %}
  </div>
  <div class="header-actions" id="save-indicator">
    {# Presence badge — populated by JS sync poll #}
    <span id="presence-indicator" class="presence-indicator" hidden></span>
    <span class="save-status" id="save-status"></span>
    <button type="button" class="btn btn-ghost btn-sm" onclick="openHistory()" title="Version history">History</button>
    {% if not restricted %}
    <button class="btn btn-primary" id="save-btn" onclick="saveActive()">Save</button>
    {% endif %}
  </div>
</div>

{# ─── Tab Nav ──────────────────────────────────────────────────────────────── #}
<div class="tab-nav">
  <button class="tab-btn {% if tab == 'advance' %}active{% endif %}" onclick="switchTab('advance')">Advance Sheet</button>
  <button class="tab-btn {% if tab == 'schedule' %}active{% endif %}" onclick="switchTab('schedule')">Production Schedule</button>
  <button class="tab-btn {% if tab == 'postnotes' %}active{% endif %}" onclick="switchTab('postnotes')">Post-Show Notes</button>
  <button class="tab-btn {% if tab == 'comments' %}active{% endif %}" onclick="switchTab('comments')">
    Comments
    <span id="comments-count-badge" class="tab-badge" hidden></span>
  </button>
  <button class="tab-btn {% if tab == 'export' %}active{% endif %}" onclick="switchTab('export')">
    Export &amp; Files
    {% if show.advance_version > 0 or show.schedule_version > 0 %}
    <span class="tab-badge">v{{ [show.advance_version, show.schedule_version]|max }}</span>
    {% endif %}
  </button>
</div>

{# ════════════════════════════════════════════════════════════════════════════ #}
{#                          ADVANCE SHEET TAB                                   #}
{# ════════════════════════════════════════════════════════════════════════════ #}
<div id="tab-advance" class="tab-pane {% if tab == 'advance' %}active{% endif %}">
<form id="advance-form" autocomplete="off">

  {% for section in form_sections %}
  <div class="form-section">
    <div class="form-section-header{% if section.collapsible %} collapsible{% endif %}"
         {% if section.collapsible %}onclick="toggleSection(this)"{% endif %}>
      <span class="section-icon">{{ section.icon }}</span> {{ section.label }}
      {% if section.collapsible %}
      <svg class="collapse-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
      {% endif %}
    </div>
    <div class="form-section-body adv-form-grid">
      {% for field in section.fields %}
        {{ render_adv_field(field) }}
      {% endfor %}
    </div>
  </div>
  {% endfor %}

</form>
</div>{# end tab-advance #}


{# ════════════════════════════════════════════════════════════════════════════ #}
{#                       PRODUCTION SCHEDULE TAB                                #}
{# ════════════════════════════════════════════════════════════════════════════ #}
<div id="tab-schedule" class="tab-pane {% if tab == 'schedule' %}active{% endif %}">
<form id="schedule-form" autocomplete="off">

  {# ── Schedule Meta ─────────────────────────────────────────────────────── #}
  <div class="form-section">
    <div class="form-section-header"><span class="section-icon">◈</span> VENUE & TECH INFO</div>
    <div class="form-section-body">
      <div class="form-row cols-4">
        <div class="field-group">
          <label class="field-label">WIFI NETWORK</label>
          <input type="text" class="field-input sched-meta" data-key="wifi_network" value="{{ meta('wifi_network') }}" placeholder="Network name" {% if restricted %}disabled{% endif %}>
        </div>
        <div class="field-group">
          <label class="field-label">WIFI CODE</label>
          <input type="text" class="field-input sched-meta" data-key="wifi_code" value="{{ meta('wifi_code') }}" placeholder="Password" {% if restricted %}disabled{% endif %}>
        </div>
        <div class="field-group">
          <label class="field-label">RADIO CHANNEL</label>
          <div class="field-input" style="background:var(--bg-hover);color:var(--text-muted);cursor:default">
            {{ adv('radio_channel') or '—' }}
          </div>
          <p class="field-hint" style="font-size:10px;color:var(--text-muted);margin-top:3px">From Advance Sheet</p>
        </div>
        <div class="field-group">
          <label class="field-label">MIX POSITION</label>
          <div class="field-input" style="background:var(--bg-hover);color:var(--text-muted);cursor:default">
            {{ adv('mix_position') or '—' }}
          </div>
          <p class="field-hint" style="font-size:10px;color:var(--text-muted);margin-top:3px">From Advance Sheet</p>
        </div>
      </div>
      <div class="field-group">
        <label class="field-label">PARKING & SECURITY INFO</label>
        <input type="text" class="field-input sched-meta" data-key="parking_security" value="{{ meta('parking_security') }}" placeholder="e.g. Judson's Live gravel lot" {% if restricted %}disabled{% endif %}>
      </div>
    </div>
  </div>

  {# ── Timeline ──────────────────────────────────────────────────────────── #}
  <div class="form-section">
    <div class="form-section-header">
      <span class="section-icon">◈</span> TIMELINE
      {% if not restricted %}
      <button type="button" class="btn btn-sm btn-ghost ml-auto" onclick="addScheduleRow()">+ Add Row</button>
      {% endif %}
    </div>
    <div class="form-section-body no-pad">
      <table class="schedule-table" id="schedule-table">
        <thead>
          <tr>
            <th style="width:110px">START</th>
            <th style="width:110px">END</th>
            <th>DESCRIPTION</th>
            <th style="width:160px">NOTES</th>
            {% if not restricted %}<th style="width:40px"></th>{% endif %}
          </tr>
        </thead>
        <tbody id="schedule-rows">
          {% if schedule_rows %}
            {% for row in schedule_rows %}
            <tr class="schedule-row" data-id="{{ row.id }}">
              <td><input type="text" class="sched-cell" placeholder="3:00pm" value="{{ row.start_time }}" {% if restricted %}disabled{% endif %}></td>
              <td><input type="text" class="sched-cell" placeholder="4:00pm" value="{{ row.end_time }}" {% if restricted %}disabled{% endif %}></td>
              <td><input type="text" class="sched-cell" placeholder="Description" value="{{ row.description }}" {% if restricted %}disabled{% endif %}></td>
              <td><input type="text" class="sched-cell" placeholder="Notes" value="{{ row.notes }}" {% if restricted %}disabled{% endif %}></td>
              {% if not restricted %}<td><button type="button" class="row-del-btn" onclick="removeRow(this)" title="Remove">×</button></td>{% endif %}
            </tr>
            {% endfor %}
          {% else %}
            <tr class="schedule-row">
              <td><input type="text" class="sched-cell" placeholder="3:00pm" value="" {% if restricted %}disabled{% endif %}></td>
              <td><input type="text" class="sched-cell" placeholder="4:00pm" value="" {% if restricted %}disabled{% endif %}></td>
              <td><input type="text" class="sched-cell" placeholder="Crew Called" value="" {% if restricted %}disabled{% endif %}></td>
              <td><input type="text" class="sched-cell" placeholder="" value="" {% if restricted %}disabled{% endif %}></td>
              {% if not restricted %}<td><button type="button" class="row-del-btn" onclick="removeRow(this)">×</button></td>{% endif %}
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    {% if not restricted %}
    <div class="form-section-footer">
      <button type="button" class="btn btn-ghost btn-sm" onclick="addScheduleRow()">+ Add Row</button>
    </div>
    {% endif %}
  </div>

  {# ── Contacts ──────────────────────────────────────────────────────────── #}
  <div class="form-section">
    <div class="form-section-header"><span class="section-icon">◈</span> SHOW CONTACTS</div>
    <div class="form-section-body">
      <h3 class="sub-section-label">ARTIST / TOUR CONTACTS</h3>
      <div class="field-group">
        <textarea class="field-input field-textarea sched-meta" data-key="artist_contacts" rows="4"
                  placeholder="Name · Role · Phone / Email (one per line)" {% if restricted %}disabled{% endif %}>{{ meta('artist_contacts') }}</textarea>
      </div>

      <h3 class="sub-section-label mt-md">DPC CONTACTS</h3>
      <div class="form-row cols-2">
        {# All DPC contacts come from the Advance Sheet (read-only here) #}
        {% for label, key in [
          ('PRODUCTION MANAGER', 'production_manager'),
          ('HOSPITALITY',        'hospitality_contact'),
          ('PROGRAMMING',        'programming'),
          ('EVENT MANAGER',      'events'),
          ('EDUCATION',          'education_contact'),
          ('GUEST SERVICES',     'guest_services'),
          ('RUNNER',             'runner_contact'),
        ] %}
        <div class="field-group">
          <label class="field-label">{{ label }}</label>
          <div class="field-input" style="background:var(--bg-hover);color:var(--text-muted);cursor:default">
            {{ adv(key) or '—' }}
          </div>
          <p class="field-hint" style="font-size:10px;color:var(--text-muted);margin-top:3px">From Advance Sheet</p>
        </div>
        {% endfor %}
        <div class="field-group">
          <label class="field-label">MIX POSITION</label>
          <div class="field-input" style="background:var(--bg-hover);color:var(--text-muted);cursor:default">
            {{ adv('mix_position') or '—' }}
          </div>
          <p class="field-hint" style="font-size:10px;color:var(--text-muted);margin-top:3px">From Advance Sheet</p>
        </div>
        <div class="field-group">
          <label class="field-label">RADIO CHANNEL</label>
          <div class="field-input" style="background:var(--bg-hover);color:var(--text-muted);cursor:default">
            {{ adv('radio_channel') or '—' }}
          </div>
          <p class="field-hint" style="font-size:10px;color:var(--text-muted);margin-top:3px">From Advance Sheet</p>
        </div>
        <div class="field-group">
          <label class="field-label">SECURITY EMAIL</label>
          <input type="text" class="field-input sched-meta" data-key="security_email"
                 value="{{ meta('security_email', 'security@drphillipscenter.org') }}" {% if restricted %}disabled{% endif %}>
        </div>
      </div>
    </div>
  </div>

</form>
</div>{# end tab-schedule #}


{# ════════════════════════════════════════════════════════════════════════════ #}
{#                         POST-SHOW NOTES TAB                                  #}
{# ════════════════════════════════════════════════════════════════════════════ #}
<div id="tab-postnotes" class="tab-pane {% if tab == 'postnotes' %}active{% endif %}">
<form id="postnotes-form" autocomplete="off">

  <div class="form-section">
    <div class="form-section-header">
      <span class="section-icon">◈</span> POST-SHOW NOTES
      <a href="{{ url_for('export_postnotes', show_id=show.id) }}" class="btn btn-sm btn-ghost ml-auto" target="_blank">Export PDF</a>
    </div>
    <div class="form-section-body">
      <div class="show-info-readonly">
        <span>{{ show.name }}</span> · <span>{{ show.show_date or '—' }}</span> · <span>{{ show.show_time or '—' }}</span> · <span>{{ show.venue or '—' }}</span>
      </div>

      <div class="form-row cols-2">
        <div class="field-group">
          <label class="field-label">PRODUCTION MANAGER</label>
          <div class="field-input" style="background:var(--bg-hover);color:var(--text-muted);cursor:default">
            {{ advance_data.get('production_manager') or note('pm') or '—' }}
          </div>
          <p class="field-hint" style="font-size:10px;color:var(--text-muted);margin-top:3px">From Advance Sheet</p>
        </div>
        <div class="field-group">
          <label class="field-label">CREW CALLED</label>
          <input type="text" class="field-input notes-field" data-key="crew_called"
                 value="{{ note('crew_called') }}" placeholder="e.g. 3:00pm" {% if restricted %}disabled{% endif %}>
        </div>
      </div>

      {% for label, key, placeholder in [
        ('SHOW NOTES (Tour/Client)', 'show_notes_tour', 'Notes from artist / tour manager perspective...'),
        ('HOUSE NOTES', 'house_notes', 'Notes about the venue, audience, house-related issues...'),
        ('EQUIPMENT / MAINTENANCE ISSUES', 'equipment_issues', 'Any technical or equipment issues that arose...'),
        ('MISCELLANEOUS', 'miscellaneous', 'Anything else worth noting...')
      ] %}
      <div class="field-group">
        <label class="field-label">{{ label }}</label>
        <textarea class="field-input field-textarea notes-field" data-key="{{ key }}"
                  rows="4" placeholder="{{ placeholder }}" {% if restricted %}disabled{% endif %}>{{ note(key) }}</textarea>
      </div>
      {% endfor %}
    </div>
  </div>

  {# Read-only production schedule timeline for reference #}
  {% if schedule_rows %}
  <div class="form-section">
    <div class="form-section-header collapsible" onclick="toggleSection(this)">
      <span class="section-icon">◈</span> PRODUCTION SCHEDULE (Reference)
      <svg class="collapse-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div class="form-section-body no-pad" style="display:none">
      <table class="data-table" style="font-size:12px">
        <thead><tr><th>START</th><th>END</th><th>DESCRIPTION</th><th>NOTES</th></tr></thead>
        <tbody>
          {% for row in schedule_rows %}
          {% if row.description or row.start_time %}
          <tr>
            <td>{{ row.start_time or '' }}</td>
            <td>{{ row.end_time or '' }}</td>
            <td>{{ row.description or '' }}</td>
            <td class="text-dim">{{ row.notes or '' }}</td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

</form>
</div>{# end tab-postnotes #}


{# ════════════════════════════════════════════════════════════════════════════ #}
{#                           COMMENTS TAB                                       #}
{# ════════════════════════════════════════════════════════════════════════════ #}
<div id="tab-comments" class="tab-pane {% if tab == 'comments' %}active{% endif %}">
  <div class="comments-container">
    <div id="comments-list" class="comments-list">
      <p class="text-dim" style="padding:20px;text-align:center;margin:0">Loading comments...</p>
    </div>
    {% if not restricted %}
    <div class="comment-input-area">
      <div class="comment-input-wrapper">
        <div class="user-avatar-sm">{{ user.display_name[0].upper() }}</div>
        <div style="flex:1;position:relative">
          <textarea id="comment-input" class="field-input field-textarea"
                    rows="2" placeholder="Add a comment… type @name to mention someone"></textarea>
          <div id="mention-dropdown" class="mention-dropdown" hidden></div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="submitComment()">Post</button>
      </div>
    </div>
    {% endif %}
  </div>
</div>{# end tab-comments #}


{# ════════════════════════════════════════════════════════════════════════════ #}
{#                           EXPORT TAB                                         #}
{# ════════════════════════════════════════════════════════════════════════════ #}
<div id="tab-export" class="tab-pane {% if tab == 'export' %}active{% endif %}">

  <div class="export-grid">
    <!-- Advance PDF -->
    <div class="export-card">
      <div class="export-card-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="40" height="40"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      </div>
      <div class="export-card-info">
        <h3>Advance Sheet PDF</h3>
        <p>Full advance form with all filled-in fields. Empty fields are omitted.</p>
        {% if show.advance_version > 0 %}
        <span class="version-badge">Current: v{{ show.advance_version }}</span>
        {% endif %}
      </div>
      <a href="{{ url_for('export_advance', show_id=show.id) }}" class="btn btn-primary" target="_blank">
        Export → v{{ (show.advance_version or 0) + 1 }}
      </a>
    </div>

    <!-- Schedule PDF -->
    <div class="export-card">
      <div class="export-card-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="40" height="40"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </div>
      <div class="export-card-info">
        <h3>Production Schedule PDF</h3>
        <p>Day-of schedule with timeline, contacts, and venue info.</p>
        {% if show.schedule_version > 0 %}
        <span class="version-badge">Current: v{{ show.schedule_version }}</span>
        {% endif %}
      </div>
      <a href="{{ url_for('export_schedule', show_id=show.id) }}" class="btn btn-primary" target="_blank">
        Export → v{{ (show.schedule_version or 0) + 1 }}
      </a>
    </div>
  </div>

  <!-- Export History -->
  {% if exports %}
  <div class="form-section mt-lg">
    <div class="form-section-header"><span class="section-icon">◈</span> EXPORT HISTORY</div>
    <div class="form-section-body no-pad">
      <table class="data-table">
        <thead><tr><th>TYPE</th><th>VERSION</th><th>EXPORTED BY</th><th>DATE</th><th>PDF</th></tr></thead>
        <tbody>
          {% for e in exports %}
          <tr>
            <td><span class="type-badge type-{{ e.export_type }}">{{ e.export_type.upper() }}</span></td>
            <td><span class="mono">v{{ e.version }}</span></td>
            <td>{{ e.exporter or '—' }}</td>
            <td class="text-dim">{{ e.exported_at[:16].replace('T',' ') }}</td>
            <td>
              {% if e.pdf_data %}
              <a href="{{ url_for('download_export_history', show_id=show.id, log_id=e.id) }}"
                 class="btn btn-xs btn-ghost" title="Re-download PDF">↓</a>
              {% else %}
              <span class="text-dim" style="font-size:10px">—</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {# ── File Attachments ─────────────────────────────────────────────────── #}
  <div class="form-section mt-lg">
    <div class="form-section-header">
      <span class="section-icon">◈</span> ATTACHMENTS
      {% if not restricted %}
      <label class="btn btn-sm btn-ghost ml-auto" for="file-upload-input" style="cursor:pointer">+ Attach File</label>
      <input type="file" id="file-upload-input" style="display:none" onchange="handleFileSelect(this)">
      {% endif %}
    </div>
    <div class="form-section-body">
      <div id="upload-zone" class="upload-zone"
           ondrop="handleFileDrop(event)" ondragover="handleFileDragOver(event)" ondragleave="handleFileDragLeave(event)">
        <span class="upload-zone-hint">Drop a file here to attach it to this show</span>
        <div id="upload-progress-wrap" style="display:none;width:100%;margin-top:8px">
          <div style="background:var(--bg-hover);border-radius:4px;height:6px;overflow:hidden">
            <div id="upload-progress-bar" style="background:var(--accent);height:100%;width:0%;transition:width 0.2s"></div>
          </div>
          <span id="upload-progress-label" style="font-size:11px;color:var(--text-muted);margin-top:4px;display:block;text-align:center">0%</span>
        </div>
      </div>
      <div id="attachments-list">
        <p class="text-dim" style="font-size:12px;margin:0">Loading...</p>
      </div>
    </div>
  </div>

  {# ── Read Receipts ─────────────────────────────────────────────────────── #}
  <div class="form-section mt-lg">
    <div class="form-section-header"><span class="section-icon">◈</span> ADVANCE READ BY</div>
    <div class="form-section-body" style="padding-top:12px;padding-bottom:12px">
      <div id="read-receipts-list" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
        <span class="text-dim" style="font-size:12px">Loading...</span>
      </div>
    </div>
  </div>

</div>{# end tab-export #}

{# ─── Version History Drawer ──────────────────────────────────────────────── #}
<div id="history-overlay" class="history-overlay" onclick="closeHistory()" style="display:none"></div>
<div id="history-drawer" class="history-drawer" style="display:none">
  <div class="history-drawer-header">
    <span class="history-drawer-title">Version History</span>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="history-form-type" class="field-input" style="width:auto;font-size:12px" onchange="loadHistory(this.value)">
        <option value="advance">Advance Sheet</option>
        <option value="schedule">Schedule</option>
        <option value="postnotes">Post-Show Notes</option>
      </select>
      <button type="button" class="btn btn-ghost btn-sm" onclick="closeHistory()">✕</button>
    </div>
  </div>
  <div id="history-list" class="history-list">
    <p class="text-dim" style="padding:16px;margin:0">Loading...</p>
  </div>
</div>

{# ─── Snapshot Preview Modal ──────────────────────────────────────────────── #}
<div id="snapshot-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeSnapshot()">
  <div class="modal-card" style="max-width:640px;max-height:80vh;overflow-y:auto">
    <div class="modal-header">
      <h3 class="modal-title">Snapshot Preview</h3>
      <button type="button" class="modal-close" onclick="closeSnapshot()">✕</button>
    </div>
    <div id="snapshot-content" class="modal-body">
      <p class="text-dim">Loading...</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-ghost" onclick="closeSnapshot()">Close</button>
      <button type="button" class="btn btn-primary" id="restore-btn" onclick="confirmRestore()">Restore This Version</button>
    </div>
  </div>
</div>

{% endblock %}

{# Autosave toast — fixed bottom-right, shown briefly after each save #}
<div id="save-toast" class="save-toast"></div>

{% block scripts %}
<script>
  const RESTRICTED = {{ 'true' if restricted else 'false' }};
  const INITIAL_TAB = '{{ tab }}';
  const ALL_USERS = {{ all_users | tojson }};
  let _currentHistId = null;
  initShow({{ show.id }}, INITIAL_TAB);

  /* ── Version History ────────────────────────────────────────── */
  function openHistory() {
    const formType = activeTab === 'advance' ? 'advance'
                   : activeTab === 'schedule' ? 'schedule'
                   : activeTab === 'postnotes' ? 'postnotes'
                   : 'advance';
    document.getElementById('history-form-type').value = formType;
    document.getElementById('history-overlay').style.display = '';
    document.getElementById('history-drawer').style.display = '';
    loadHistory(formType);
  }

  function closeHistory() {
    document.getElementById('history-overlay').style.display = 'none';
    document.getElementById('history-drawer').style.display = 'none';
  }

  async function loadHistory(formType) {
    const list = document.getElementById('history-list');
    list.innerHTML = '<p class="text-dim" style="padding:16px;margin:0">Loading...</p>';
    try {
      const resp = await fetch(`/shows/${SHOW_ID}/history/${formType}`);
      const entries = await resp.json();
      if (!entries.length) {
        list.innerHTML = '<p class="text-dim" style="padding:16px;margin:0">No history yet. Save the form to create snapshots.</p>';
        return;
      }
      list.innerHTML = entries.map(e => `
        <div class="history-entry">
          <div class="history-entry-meta">
            <strong>${e.saved_by_name}</strong>
            <span class="text-dim" style="font-size:11px">${e.saved_at ? e.saved_at.substring(0,16).replace('T',' ') : '—'}</span>
          </div>
          <div class="history-entry-actions">
            <button class="btn btn-xs btn-ghost" onclick="previewSnapshot(${e.id})">Preview</button>
            ${!RESTRICTED ? `<button class="btn btn-xs btn-ghost" onclick="restoreSnapshot(${e.id})">Restore</button>` : ''}
          </div>
        </div>
      `).join('');
    } catch(err) {
      list.innerHTML = '<p class="text-dim" style="padding:16px;margin:0">Failed to load history.</p>';
    }
  }

  async function previewSnapshot(histId) {
    _currentHistId = histId;
    document.getElementById('snapshot-modal').style.display = '';
    document.getElementById('snapshot-content').innerHTML = '<p class="text-dim">Loading...</p>';
    try {
      const resp = await fetch(`/shows/${SHOW_ID}/history/${histId}/snapshot`);
      const snap = await resp.json();
      const data = snap.data || {};
      let html = `<p style="margin-bottom:12px;font-size:12px;color:var(--text-dim)">
        Saved ${snap.saved_at ? snap.saved_at.substring(0,16).replace('T',' ') : '—'}
      </p><table class="data-table" style="font-size:12px">`;

      const flat = data.advance_data || data.notes_data || {};
      const rows = data.rows || [];

      if (Object.keys(flat).length) {
        html += '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>';
        for (const [k, v] of Object.entries(flat)) {
          if (v && v !== '-' && v !== 'false') {
            html += `<tr><td style="color:var(--text-dim);white-space:nowrap">${k.replace(/_/g,' ')}</td><td>${v}</td></tr>`;
          }
        }
        html += '</tbody>';
      } else if (rows.length) {
        html += '<thead><tr><th>Start</th><th>End</th><th>Description</th><th>Notes</th></tr></thead><tbody>';
        rows.forEach(r => {
          html += `<tr><td>${r.start_time||''}</td><td>${r.end_time||''}</td><td>${r.description||''}</td><td>${r.notes||''}</td></tr>`;
        });
        html += '</tbody>';
      }
      html += '</table>';
      document.getElementById('snapshot-content').innerHTML = html;
    } catch(err) {
      document.getElementById('snapshot-content').innerHTML = '<p class="text-dim">Failed to load snapshot.</p>';
    }
  }

  function closeSnapshot() {
    document.getElementById('snapshot-modal').style.display = 'none';
    _currentHistId = null;
  }

  async function confirmRestore() {
    if (!_currentHistId) return;
    if (!confirm('Restore this version? The current form data will be overwritten.')) return;
    try {
      const resp = await fetch(`/shows/${SHOW_ID}/history/${_currentHistId}/restore`, {method:'POST'});
      const d = await resp.json();
      if (d.success) {
        closeSnapshot();
        closeHistory();
        location.reload();
      } else {
        alert('Restore failed: ' + (d.error || 'Unknown error'));
      }
    } catch(err) {
      alert('Network error during restore.');
    }
  }

  function restoreSnapshot(histId) {
    previewSnapshot(histId).then(() => {
      document.getElementById('snapshot-modal').style.display = '';
    });
  }

</script>
{% endblock %}
