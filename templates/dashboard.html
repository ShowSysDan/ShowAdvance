{% extends "base.html" %}
{% block title %}Dashboard — DPC Advance{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title">Shows</h1>
    <p class="page-sub">{{ active_shows|length }} active · {{ archived_shows|length }} archived</p>
  </div>
  {% if not restricted %}
  <a href="{{ url_for('new_show') }}" class="btn btn-primary">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    New Show
  </a>
  {% endif %}
</div>

{% if venue_groups %}

{# ── Toolbar ──────────────────────────────────────────────────────────────── #}
<div class="dash-toolbar">
  <div class="dash-search-wrap">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15" class="dash-search-icon"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input type="text" id="dash-search" class="dash-search-input" placeholder="Search shows…" oninput="filterDash(this.value)" autocomplete="off">
    <button id="dash-clear-btn" class="dash-clear-btn" onclick="clearSearch()" style="display:none" title="Clear">×</button>
  </div>
  <div class="dash-venue-pills" id="dash-venue-pills">
    {% for venue, _ in venue_groups %}
    <button class="venue-pill active" data-venue="{{ venue }}" onclick="toggleVenue(this)">{{ venue }}</button>
    {% endfor %}
  </div>
</div>

{# ── Venue Columns ────────────────────────────────────────────────────────── #}
<div class="venue-columns" id="venue-columns">
  {% for venue, shows in venue_groups %}
  <div class="venue-col" data-venue="{{ venue }}">
    <div class="venue-col-header">
      <span class="venue-col-name">{{ venue }}</span>
      <span class="venue-col-count">{{ shows|length }}</span>
    </div>
    <div class="venue-col-body">
      {% for s in shows %}
      <div class="show-card" data-search="{{ s.name|lower }}">
        <div class="show-card-top">
          <div class="show-date-badge">
            {% if s.show_date %}
              <span class="show-month">{{ s.show_date[:7].replace('-','/') }}</span>
              <span class="show-day">{{ s.show_date[-2:] }}</span>
            {% else %}
              <span class="show-month">NO</span>
              <span class="show-day">DATE</span>
            {% endif %}
          </div>
          <div class="show-info">
            <div class="show-name">{{ s.name }}{% if s.perf_count > 1 %}<span class="multi-date-badge">{{ s.perf_count }} DATES</span>{% endif %}</div>
            <div class="show-meta">{% if s.show_time %}{{ s.show_time }}{% else %}—{% endif %}</div>
          </div>
        </div>
        <div class="show-card-actions">
          <a href="{{ url_for('show_page', show_id=s.id, tab='advance') }}" class="btn btn-sm btn-ghost">Advance</a>
          <a href="{{ url_for('show_page', show_id=s.id, tab='schedule') }}" class="btn btn-sm btn-ghost">Schedule</a>
          <a href="{{ url_for('show_page', show_id=s.id, tab='export') }}" class="btn btn-sm btn-accent">Export</a>
          {% if not restricted %}
          <form method="post" action="{{ url_for('archive_show', show_id=s.id) }}" style="display:inline" onsubmit="return confirm('Archive this show?')">
            <button type="submit" class="btn btn-sm btn-danger-ghost" title="Archive">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
            </button>
          </form>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    <p class="venue-col-empty" style="display:none">No matching shows</p>
  </div>
  {% endfor %}
</div>

<p id="dash-no-results" class="text-dim" style="display:none;font-size:13px;padding:24px 0">No shows match your search.</p>

{% else %}
<div class="empty-state">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
  <p>No active shows. <a href="{{ url_for('new_show') }}">Create one →</a></p>
</div>
{% endif %}

{# ── Archived ─────────────────────────────────────────────────────────────── #}
{% if archived_shows %}
<section class="section" style="margin-top:32px">
  <button class="section-label toggle-archived" onclick="document.getElementById('archived-list').classList.toggle('hidden')">
    ARCHIVED ({{ archived_shows|length }})
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="6 9 12 15 18 9"/></svg>
  </button>
  <div id="archived-list" class="show-grid archived hidden" style="margin-top:12px">
    {% for s in archived_shows %}
    <div class="show-card archived">
      <div class="show-card-top">
        <div class="show-date-badge dim">
          {% if s.show_date %}
            <span class="show-month">{{ s.show_date[:7].replace('-','/') }}</span>
            <span class="show-day">{{ s.show_date[-2:] }}</span>
          {% else %}
            <span class="show-month">—</span><span class="show-day">—</span>
          {% endif %}
        </div>
        <div class="show-info">
          <div class="show-name">{{ s.name }}</div>
          <div class="show-meta">{{ s.venue or '—' }}</div>
        </div>
      </div>
      <div class="show-card-actions">
        <a href="{{ url_for('show_page', show_id=s.id, tab='advance') }}" class="btn btn-sm btn-ghost">View</a>
        <form method="post" action="{{ url_for('restore_show', show_id=s.id) }}" style="display:inline">
          <button class="btn btn-sm btn-ghost">Restore</button>
        </form>
        {% if user.role == 'admin' %}
        <form method="post" action="{{ url_for('delete_show', show_id=s.id) }}" style="display:inline" onsubmit="return confirm('Permanently delete this show and all its data?')">
          <button class="btn btn-sm btn-danger-ghost">Delete</button>
        </form>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
const _hiddenVenues = new Set();

function filterDash(q) {
  const term = (q || '').toLowerCase().trim();
  document.getElementById('dash-clear-btn').style.display = term ? '' : 'none';

  let totalVisible = 0;
  document.querySelectorAll('.venue-col').forEach(col => {
    if (_hiddenVenues.has(col.dataset.venue)) return;
    let colVisible = 0;
    col.querySelectorAll('.show-card').forEach(card => {
      const match = !term || card.dataset.search.includes(term);
      card.style.display = match ? '' : 'none';
      if (match) colVisible++;
    });
    col.querySelector('.venue-col-empty').style.display = colVisible === 0 ? '' : 'none';
    col.querySelector('.venue-col-count').textContent = colVisible;
    totalVisible += colVisible;
  });

  document.getElementById('dash-no-results').style.display =
    (totalVisible === 0 && term) ? '' : 'none';
}

function clearSearch() {
  const inp = document.getElementById('dash-search');
  inp.value = '';
  filterDash('');
  inp.focus();
}

function toggleVenue(btn) {
  const venue = btn.dataset.venue;
  const col = document.querySelector(`.venue-col[data-venue="${CSS.escape(venue)}"]`);
  if (_hiddenVenues.has(venue)) {
    _hiddenVenues.delete(venue);
    btn.classList.add('active');
    if (col) col.style.display = '';
  } else {
    _hiddenVenues.add(venue);
    btn.classList.remove('active');
    if (col) col.style.display = 'none';
  }
}
</script>
{% endblock %}
